<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫£n ph·∫©m - C·ª≠a h√†ng</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/product.css">
</head>
<body>
    <!-- Include header -->
    <%- include('partials/header') %>
    <div class="marquee">
        <h1>DAY LA DANH SACH SAN PHAM, CHUC QUY KHACH CO TRAI NGHIEM MUA HANG VUI VE VA TIM DUOC SAN PHAM PHU HOP VOI MINH</h1>
    </div>
    <main>
        <div class="product-list">
            <% products.forEach(product => { %>
                <div class="product-item">
                    <img src="<%= product.image %>" alt="<%= product.name %>" class="product-img">

                    <h3 class="product-name"><%= product.name %></h3>

                    <p>Gi√°: <%= product.price %> VND</p>
                    <a href="/product/<%= product.idSP %>">Xem chi ti·∫øt</a>
                    <!-- Ch·ªçn size -->
                    <p><strong> Size:</strong></p>
                    <div class="size-options">
                        <% product.sizes.forEach((size, index) => { %>
                            <button 
                                class="size-btn" 
                                data-product-id="<%= product.idSP %>"
                                data-size="<%= size.size %>"
                                data-quantity="<%= size.quantity %>"
                                <%= size.quantity === 0 ? 'disabled' : '' %>
                            >
                                <%= size.size %> (<%= size.quantity === 0 ? 'H·∫øt h√†ng' : 'C√≤n ' + size.quantity %>)
                            </button>
                        <% }) %>
                        
                    </div>
        
                    <!-- Ch·ªçn s·ªë l∆∞·ª£ng -->
                    <p><strong> S·ªë l∆∞·ª£ng:</strong></p>
                    <input 
                        type="number" 
                        class="quantity-input" 
                        data-product-id="<%= product.idSP %>" 
                        min="1" 
                        max="0" 
                        value="1"
                        disabled
                    >
        
                    
                        <input type="hidden" name="idSP" value="<%= product.idSP %>">
                        <input type="hidden" name="size" class="selected-size" data-product-id="<%= product.idSP %>">
                        <input type="hidden" name="quantity" class="selected-quantity" data-product-id="<%= product.idSP %>">
                        <button type="submit" class="add-to-cart-btn" data-product-id="<%= product.idSP %>" disabled>Th√™m v√†o gi·ªè h√†ng</button>

                    
                </div>
            <% }) %>
        </div>
        
    
        <div class="pagination">
            <% if (currentPage > 1) { %>
                <a href="?page=<%= currentPage - 1 %>&limit=4">Tr∆∞·ªõc</a>
            <% } %>
        
            <% for (let i = 1; i <= totalPages; i++) { %>
                <a href="?page=<%= i %>&limit=4" class="<%= i === currentPage ? 'active' : '' %>"><%= i %></a>
            <% } %>
        
            <% if (currentPage < totalPages) { %>
                <a href="?page=<%= currentPage + 1 %>&limit=4">Ti·∫øp</a>
            <% } %>
        </div>
        
    </main>
    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".size-btn").forEach(button => {
                button.addEventListener("click", function () {
                    const productId = this.dataset.productId;
                    const selectedSize = this.dataset.size;
                    const maxQuantity = this.dataset.quantity;
    
                    // B·ªè ch·ªçn t·∫•t c·∫£ n√∫t size tr∆∞·ªõc ƒë√≥
                    document.querySelectorAll(`.size-btn[data-product-id='${productId}']`).forEach(btn => {
                        btn.classList.remove("selected");
                    });
    
                    // ƒê√°nh d·∫•u size ƒë√£ ch·ªçn
                    this.classList.add("selected");
    
                    // C·∫≠p nh·∫≠t input s·ªë l∆∞·ª£ng
                    const quantityInput = document.querySelector(`.quantity-input[data-product-id='${productId}']`);
                    quantityInput.max = maxQuantity;
                    quantityInput.value = maxQuantity > 0 ? 1 : 0;
                    quantityInput.disabled = maxQuantity == 0;
    
                    // C·∫≠p nh·∫≠t input hidden
                    document.querySelector(`.selected-size[data-product-id='${productId}']`).value = selectedSize;
                    document.querySelector(`.selected-quantity[data-product-id='${productId}']`).value = quantityInput.value;
    
                    // K√≠ch ho·∫°t n√∫t "Th√™m v√†o gi·ªè h√†ng"
                    const productItem = this.closest(".product-item"); // T√¨m div cha ch·ª©a s·∫£n ph·∫©m
                    const addToCartBtn = productItem.querySelector(".add-to-cart-btn"); // T√¨m n√∫t trong s·∫£n ph·∫©m
                    if (addToCartBtn) {
                        addToCartBtn.disabled = maxQuantity == 0; // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu t√¨m th·∫•y n√∫t
                    } else {
                        console.error("Kh√¥ng t√¨m th·∫•y n√∫t Th√™m v√†o gi·ªè h√†ng cho s·∫£n ph·∫©m:", productId);
                    }

                    addToCartBtn.disabled = maxQuantity == 0;
                });
            });
    
            // G·ªçi API khi b·∫•m "Th√™m v√†o gi·ªè h√†ng"
            document.addEventListener("click", async function (event) {
            if (event.target.classList.contains("add-to-cart-btn")) {
                const productItem = event.target.closest(".product-item");

                if (!productItem) {
                    console.error("‚ùå Kh√¥ng t√¨m th·∫•y product-item!");
                    return;
                }

                const productId = productItem.querySelector("input[name='idSP']").value;

                const sizeElement = productItem.querySelector(".selected-size");
                if (!sizeElement || !sizeElement.value) {
                    alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn size tr∆∞·ªõc khi th√™m v√†o gi·ªè h√†ng!");
                    return;
                }
                const selectedSize = sizeElement.value;

                const selectedQuantity = productItem.querySelector(".quantity-input").value;

                // L·∫•y h√¨nh ·∫£nh s·∫£n ph·∫©m
                const imgElement = productItem.querySelector("img");
                const productImage = imgElement ? imgElement.src : "";

                // L·∫•y t√™n s·∫£n ph·∫©m
                const nameElement = productItem.querySelector(".product-name");
                const productName = nameElement ? nameElement.textContent : "Kh√¥ng c√≥ t√™n";

                // L·∫•y gi√° s·∫£n ph·∫©m
                const priceElement = productItem.querySelector("p");
                const productPrice = priceElement ? parseFloat(priceElement.textContent.replace(/[^0-9.-]+/g, "")) : 0;

                if (!selectedSize || selectedQuantity <= 0) {
                    alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn size v√† s·ªë l∆∞·ª£ng h·ª£p l·ªá!");
                    return;
                }

                const data = {
                    idSP: productId,
                    size: selectedSize,
                    quantity: selectedQuantity,
                    image: productImage,
                    name: productName,
                    price: productPrice
                };

                console.log("üì§ G·ª≠i d·ªØ li·ªáu l√™n API:", data);

                try {
                    const response = await fetch("/api/cart/add", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    console.log("üì© K·∫øt qu·∫£ API:", result);

                    if (response.ok) {
                        alert("üõí S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m v√†o gi·ªè h√†ng!");
                    } else {
                        alert("‚ö†Ô∏è L·ªói: " + result.error);
                    }
                } catch (error) {
                    console.error("‚ùå L·ªói khi g·ªçi API:", error);
                }
            }
        });


    
            // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng khi thay ƒë·ªïi input
            document.querySelectorAll(".quantity-input").forEach(input => {
                input.addEventListener("input", function () {
                    const productId = this.dataset.productId;
                    document.querySelector(`.selected-quantity[data-product-id='${productId}']`).value = this.value;
                });
            });
        });
    </script>
    

    
    
    
    

    <!-- Include footer -->
    <%- include('partials/footer') %>
</body>
</html>

