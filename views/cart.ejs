<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè h√†ng</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/cart.css">
</head>
<body>
    <%- include('partials/header') %>
    <main>
        <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>
        <a href="/products">‚¨ÖÔ∏è Ti·∫øp t·ª•c mua s·∫Øm</a>
        <% if (cart.length === 0) { %>
            <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
        <% } else { %>
            <div class="cart-container">
                <table border="1">
                    <thead>
                        <tr>
                            <th>H√¨nh ·∫£nh</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Size</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√°</th>
                            <th>T·ªïng</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% let totalPrice = 0; %>
                        <% cart.forEach(item => { %>
                            <% let itemTotal = item.price * item.quantity; %>
                            <% totalPrice += itemTotal; %>
                            <tr>
                                <td><img src="<%= item.image %>" alt="<%= item.name %>" width="50"></td>
                                <td><%= item.name %></td>
                                <td><%= item.size %></td>
                                <td><%= item.quantity %></td>
                                <td><%= item.price.toLocaleString() %> VND</td>
                                <td><%= itemTotal.toLocaleString() %> VND</td>
                                <td>
                                    <button onclick="removeFromCart('<%= item.idSP %>', '<%= item.size %>')">‚ùå Xo√°</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            

            <h3>üí∞ T·ªïng ti·ªÅn: <span id="totalPrice"><%= totalPrice.toLocaleString() %></span> VND</h3>

            <!-- Th√™m ph·∫ßn m√£ gi·∫£m gi√° -->
            <div>
                <label for="discountCode">Nh·∫≠p m√£ gi·∫£m gi√°:</label>
                <input type="text" id="discountCode" placeholder="M√£ gi·∫£m gi√°">
                <button onclick="applyDiscount()">√Åp d·ª•ng</button>
            </div>

            <!-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n -->
            <div>
                <h3>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</h3>
                <input type="radio" id="cod" name="paymentMethod" value="Ch∆∞a thanh to√°n" checked>
                <label for="cod">Thanh to√°n khi nh·∫≠n h√†ng</label><br>
                <input type="radio" id="online" name="paymentMethod" value="ƒê√£ thanh to√°n online">
                <label for="online">Thanh to√°n online</label>
            </div>

            <button onclick="clearCart()">üóëÔ∏è Xo√° to√†n b·ªô gi·ªè h√†ng</button>
            <button onclick="checkout()">üõçÔ∏è Thanh to√°n</button>
        <% } %>
        
    </main>
    <script>
        async function removeFromCart(idSP, size) {
            await fetch('/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idSP, size })
            });
            location.reload();
        }

        async function clearCart() {
            await fetch('/cart/clear', { method: 'POST' });
            location.reload();
        }

        async function applyDiscount() {
            const discountCode = document.getElementById('discountCode').value;
            if (!discountCode) {
                alert("Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°");
                return;
            }
            const response = await fetch('/cart/apply-discount', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ discountCode })
            });

            const result = await response.json();
            if (response.ok) {
                alert(result.message);

                if (result.discountedTotal) {
                    document.getElementById('totalPrice').innerText = result.discountedTotal.toLocaleString() + ' VND';
                }
            } else {
                alert(result.error);
            }
        }

        async function checkout() {
            const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const response = await fetch('/cart/checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentMethod: selectedPaymentMethod })
            });
            const result = await response.json();

            if (response.ok) {
                if (result.payUrl) {
                    window.location.href = result.payUrl;  // Chuy·ªÉn ƒë·∫øn trang thanh to√°n MoMo
                } else {
                    alert(result.message);
                    window.location.href = '/';
                }
            } else {

                if (result.insufficientStock) {
                    let message = "M·ªôt s·ªë s·∫£n ph·∫©m kh√¥ng ƒë·ªß h√†ng:\n";
                    result.insufficientStock.forEach(item => {
                        message += `${item.name} (Size: ${item.size}) ch·ªâ c√≤n ${item.available} s·∫£n ph·∫©m.\n`;
                    });
                    alert(message);
                } else {
                    alert(result.error);
                }
            }
        }
    </script>
    <%- include('partials/footer') %>
</body>
</html>